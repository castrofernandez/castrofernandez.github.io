function iniciarTetris(){"none"!=tetris.style.display&&(juego&&juego.finalizar(),juego=new Juego,juego.iniciar())}function Juego(){function a(){this.tablero.generar();var a=this;h=setInterval(function(){a.bucle()},TETRIS_VELOCIDAD)}function b(){h&&clearInterval(h)}function c(){if(!g){null==this.pieza&&(this.pieza=this.generarNuevaPieza()),this.pieza.mostrar(!0),this.pieza.avanzarAbajo()||(this.pieza=null);var a=this.tablero.puntos,b=this.tablero.nivel;this.mostrarPuntos(a,b),null!=this.pieza&&this.pieza.finJuego&&(clearInterval(h),h=null,this.iniciar())}}function d(a,b){var c=a,d=b;1e3>a&&(c="0"+a),100>a&&(c="0"+c),10>a&&(c="0"+c),10>b&&(d="0"+d),this.level.innerHTML=this.level2.innerHTML="LEVEL "+d,this.score.innerHTML="SCORE "+c}function e(){var a=new Pieza(this.tablero),b=a.rotar(),c=b.rotar(),d=c.rotar();return f([a.evaluarMejorPosicion(),b.evaluarMejorPosicion(),c.evaluarMejorPosicion(),d.evaluarMejorPosicion()])}function f(a){for(var b=a[0],c=1;c<a.length;c++)a[c].mejorResultado>b.mejorResultado&&(b=a[c]);return b}this.tablero=new Tablero,this.pieza=null;var g=!1;this.iniciar=a,this.finalizar=b,this.bucle=c,this.generarNuevaPieza=e,this.obtenerMejorPieza=f,this.mostrarPuntos=d,this.score=document.getElementById("score"),this.level=document.getElementById("level"),this.level2=document.getElementById("level2");var h=null}function Tablero(){function a(){this.puntos=TETRIS_PUNTOS_INICIALES;var a=document.getElementById("tetris");a.innerHTML="";var b=a.offsetWidth;a.style.height=b+"px";var c={ancho:Math.floor(b/TETRIS_NUM_COLUMNAS),alto:Math.floor(b/TETRIS_NUM_FILAS)};a.style.paddingTop=b-c.alto*TETRIS_NUM_FILAS+"px",a.style.paddingLeft=b-c.ancho*TETRIS_NUM_COLUMNAS+"px",c.ancho+="px",c.alto+="px";for(var d=0;d<this.TETRIS_NUM_FILAS;d++){this.casillas[d]=new Array,this.matriz[d]=new Array,this.matriz[d][this.TETRIS_NUM_COLUMNAS]=0;for(var e=0;e<this.TETRIS_NUM_COLUMNAS;e++)this.casillas[d][e]=document.createElement("div"),this.casillas[d][e].style.width=c.ancho,this.casillas[d][e].style.height=c.alto,d>=this.TETRIS_NUM_FILAS-TETRIS_FILAS_INICIALES&&0!=Math.floor(3*Math.random())&&this.matriz[d][this.TETRIS_NUM_COLUMNAS]<this.TETRIS_NUM_COLUMNAS-1?(this.casillas[d][e].className="bloqueTetrisMarcado",this.matriz[d][e]=1,this.matriz[d][this.TETRIS_NUM_COLUMNAS]=this.matriz[d][this.TETRIS_NUM_COLUMNAS]+1):(this.casillas[d][e].className="bloqueTetrisVacio",this.matriz[d][e]=0),a.appendChild(this.casillas[d][e])}}function b(a,b){this.matriz[b][a]=1,this.matriz[b][this.TETRIS_NUM_COLUMNAS]=this.matriz[b][this.TETRIS_NUM_COLUMNAS]+1}function c(a,b){return 1==this.valorEnPosicion(a,b)}function d(a,b){try{return this.matriz[b][a]}catch(c){alert(a+" "+b)}}function e(a,b){for(var c=0;c<a.elemento.length;c++)for(var d=0;d<a.elemento[c].length;d++)1==a.elemento[c][d]&&(this.casillas[a.y+c][a.x+d].className=1==b?"bloqueTetrisMarcado":"bloqueTetrisVacio")}function f(a){if(this.matriz[a][this.TETRIS_NUM_COLUMNAS]==this.TETRIS_NUM_COLUMNAS){for(var b=a;b>0;b--){for(var c=0;c<this.TETRIS_NUM_COLUMNAS;c++)this.matriz[b][c]=this.matriz[b-1][c],this.casillas[b][c].className=this.casillas[b-1][c].className;this.matriz[b][TETRIS_NUM_COLUMNAS]=this.matriz[b-1][TETRIS_NUM_COLUMNAS]}for(var c=0;c<this.TETRIS_NUM_COLUMNAS;c++)this.matriz[0][c]=0,this.casillas[0][c].className="bloqueTetrisVacio";this.matriz[0][this.TETRIS_NUM_COLUMNAS]=0,this.puntos+=TETRIS_BONIFICACION_POR_FILA,this.puntos>=9999&&(this.puntos=0,this.nivel+=1,this.nivel>99&&(this.nivel=1))}}this.TETRIS_NUM_FILAS=TETRIS_NUM_FILAS,this.TETRIS_NUM_COLUMNAS=TETRIS_NUM_COLUMNAS,this.casillas=new Array,this.matriz=new Array,this.nivel=1,this.puntos=0,this.generar=a,this.fijarPiezaEnTablero=b,this.estaPosicionOcupada=c,this.mostrarPieza=e,this.valorEnPosicion=d,this.compruebaFilaLlena=f}function Pieza(a){function b(a){this.tablero.mostrarPieza(this,a)}function c(){return this.esPosibleAvanzar(this.x,this.y+1)?(this.mostrar(!1),this.y=this.y+1,this.mostrar(!0),!0):(this.fijarPiezaEnTablero(),!1)}function d(){for(var a=0;a<this.elemento.length;a++)for(var b=0;b<this.elemento[a].length;b++)1==this.elemento[a][b]&&this.tablero.fijarPiezaEnTablero(this.x+b,this.y+a);for(var a=0;a<this.elemento.length;a++)this.tablero.compruebaFilaLlena(this.y+a)}function e(a,b){if(b>=this.tablero.TETRIS_NUM_FILAS||b+this.elemento.length-1>=this.tablero.TETRIS_NUM_FILAS||a>=this.tablero.TETRIS_NUM_COLUMNAS||0>a)return!1;for(var c=0;c<this.elemento.length;c++)for(var d=0;d<this.elemento[c].length;d++)if(this.tablero.estaPosicionOcupada(a+d,b+c)&&1==this.elemento[c][d])return!1;return!0}function f(a,b){for(var c=0,d=0,e=this.tablero.TETRIS_NUM_FILAS-1;e>=0&&this.tablero.valorEnPosicion(this.tablero.TETRIS_NUM_COLUMNAS,e)>0;)d=this.tablero.valorEnPosicion(this.tablero.TETRIS_NUM_COLUMNAS,e),d+=this.valorVerticalPieza(b,e),d==this.tablero.TETRIS_NUM_COLUMNAS&&c++,e--;return 100*c+b-this.numeroHuecosPorDebajo(a,b)}function g(a,b){if(b-a>=this.elemento.length||a>b)return 0;for(var c=0,d=0;d<this.elemento[0].length;d++)c+=this.elemento[b-a][d];return c}function h(a,b){for(var c=0,d=0;d<this.elemento.length;d++)for(var e=0;e<this.elemento[0].length;e++)1==this.elemento[d][e]&&(d==this.elemento.length-1||0==this.elemento[d+1][e])&&(b+d+1!=this.tablero.TETRIS_NUM_FILAS&&this.tablero.estaPosicionOcupada(a+e,b+d+1)||c++);return c}function i(){for(var a,b=0,c=0,d=0,e=0;e<=this.tablero.TETRIS_NUM_COLUMNAS-this.elemento[0].length;e++){for(;this.esPosibleAvanzar(e,b);)b++;a=this.numeroFilasCompletadas(e,b>0?b-1:0),a>d&&(c=e,d=a),b=0}return this.x=c,this.mejorResultado=d,this}function j(){var a=this.rotacion+1;4==a&&(a=0);var b=new Pieza(this.tablero);return b.elemento=piezas[a][this.codPieza],b.rotacion=a,b}this.tablero=a,this.codPieza=Math.floor(8*Math.random()),this.rotacion=0,this.elemento=piezas[0][this.codPieza],this.x=4,this.y=0,this.mejorResultado=0,this.mostrar=b,this.avanzarAbajo=c,this.esPosibleAvanzar=e,this.fijarPiezaEnTablero=d,this.evaluarMejorPosicion=i,this.rotar=j,this.numeroFilasCompletadas=f,this.valorVerticalPieza=g,this.numeroHuecosPorDebajo=h,this.finJuego=!this.esPosibleAvanzar(this.x,this.y)}var TETRIS_NUM_FILAS=10,TETRIS_NUM_COLUMNAS=10,TETRIS_FILAS_INICIALES=4,TETRIS_PUNTOS_INICIALES=250,TETRIS_BONIFICACION_POR_FILA=50,TETRIS_VELOCIDAD=200,piezas=[[[[1]],[[1],[1],[1],[1]],[[0,1,0],[1,1,1]],[[1,1],[1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0],[1,0],[1,1]],[[0,1],[0,1],[1,1]]],[[[1]],[[1,1,1,1]],[[1,0],[1,1],[1,0]],[[1,1],[1,1]],[[0,1],[1,1],[1,0]],[[1,0],[1,1],[0,1]],[[1,1,1],[1,0,0]],[[1,0,0],[1,1,1]]],[[[1]],[[1],[1],[1],[1]],[[1,1,1],[0,1,0]],[[1,1],[1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,1],[0,1],[0,1]],[[1,1],[1,0],[1,0]]],[[[1]],[[1],[1],[1],[1]],[[0,1],[1,1],[0,1]],[[1,1],[1,1]],[[0,1],[1,1],[1,0]],[[1,0],[1,1],[0,1]],[[0,0,1],[1,1,1]],[[1,1,1],[0,0,1]]]],juego=null,tetris=document.getElementById("tetris");iniciarTetris(),window.attachEvent?window.attachEvent("onresize",iniciarTetris):window.addEventListener("resize",iniciarTetris,!1);